# 形態素解析校正仕様書

AIを使用しない、ローカルでの形態素解析による文章校正機能の仕様。

## 概要

`kuromoji.js` 等のローカルで動作する形態素解析ライブラリを使用し、執筆中の小説の校正支援を行う。
AI（LLM）とは異なり、ルールベースで高速かつオフラインで動作し、確実な指摘を行うことを目的とする。

## UI仕様

### 校正パネル (Calibration Panel)

- リーディングバー（サイドバー）に「校正」アイコンを追加。
- クリックすると右ペイン（または左ペイン、設定により可変）に校正パネルを表示。
- パネル内には以下のタブまたはセクションを設ける。
    1.  **頻出語句 (Frequency)**
    2.  **文章チェック (Inspection)**
    3.  **表記ゆれ (Consistence)**

## 機能詳細

### 1. 頻出語句リストアップ (Frequency Analysis)

- **目的**: 同じ単語の使いすぎを防ぐ、文章の癖を把握する。
- **機能**:
    - 文章全体（または選択範囲）の形態素解析を行い、品詞ごとに頻出単語をリストアップ。
    - **フィルター**: 名詞、動詞、形容詞、形容動詞、副詞などでフィルタリング可能。
    - **表示**: 単語と出現回数をリスト表示。クリックするとエディター内の該当箇所を検索・ハイライト（順次移動）。

### 2. 文章チェック (Sentence Inspection)

- **助詞の連続チェック**:
    - 「の」「が」「に」「を」などが連続して使用されている文を検出。
    - 例: 「私の父の友人の家」
    - 設定で連続回数の閾値を指定可能（デフォルト: 3回以上など）。
- **こそあど言葉の過多**:
    - 指示語（これ、それ、あれ、どれ）の多用をチェック。
- **文末の重複**:
    - 文末（「〜た」「〜だ」など）が連続している箇所を検出。
    - 単調なリズムを防ぐため。

### 3. 表記ゆれ・漢字の開きチェック (Consistency & Kanji Usage)

- **表記ゆれ**:
    - 同一と思われる単語で、表記が異なるものを検出。
    - 例: 「子供」と「子ども」、「バイオリン」と「ヴァイオリン」。
    - ユーザー辞書による登録も検討。
- **漢字の開き（Open/Close）チェック**:
    - 本来ひらがなで書くべき副詞や形式名詞が漢字で書かれている場合、またはその逆を指摘。
    - **開くべき漢字（例）**:
        - 事 → こと（形式名詞）
        - 時 → とき（形式名詞）
        - 所 → ところ（形式名詞）
        - 殆ど → ほとんど
        - 敢えて → あえて
    - **閉じるべき（漢字で書くべき）語**:
        - ユーザー設定また一般規則に基づく。
    - これらは「警告」としてリストアップし、一括または個別に置換を提案。

### 4. エディター連携 (Editor Integration)

- **リアルタイム表示**:
    - 校正パネルを開いている間、問題箇所にエディター上で波線（Decoration）を表示（VSCodeのProblem表示のようなイメージ）。
    - 波線の色は指摘の種類によって分ける（例: 重複は青、連続助詞は黄色、表記ゆれは赤など）。
- **ホバー表示**:
    - 波線箇所をホバーすると、指摘内容を表示。
- **ジャンプ機能**:
    - パネルのリスト項目をクリックすると、エディターの該当箇所へスクロール・フォーカス。

## 技術スタック

- **形態素解析エンジン**: `kuromoji.js` (Dictionary loading performance to be considered) or `sudachi.js` / native bindings if performance is an issue.
    - まずは `kuromoji.js` でプロトタイプ。
    - 辞書データはアプリに同梱。
- **実装場所**:
    - 解析自体は重くなる可能性があるため、WebWorker または Main Process (via IPC) で実行し、結果を Renderer に返す非同期処理とする。
    - 解析結果（トークン列）はキャッシュし、変更があった行（または段落）のみ再解析する差分更新を検討、あるいは一定時間操作がない時に全解析。

## データ構造（案）

```typescript
interface CalibrationIssue {
  id: string;
  type: 'particle_repetition' | 'word_frequency' | 'consistency' | 'kanji_open_close';
  message: string;
  range: {
    startLine: number;
    startColumn: number;
    endLine: number;
    endColumn: number;
  };
  suggestion?: string; // 置換候補
}
```
